<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Favicon -->
    <link rel="icon" href="/favicon_ico/favicon.ico" type="image/x-icon" />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>For Greatness - Deobfuscating a PHP Backdoor</title>

    <link rel="stylesheet" href="/CSS/style.css" />
    <link rel="stylesheet" href="/CSS/blog.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      integrity="sha384-wFjoQjtV1y5jVHbt0p35Ui8aV8GVpEZkyF99OXWqP/eNJDU93D3Ugxkoyh6Y2I4A"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      integrity="sha384-/o6I2CkkWC//PSjvWC/eYN7l3xM3tJm8ZzVkCOfp//W05QcE3mlGskpoHB6XqI+B"
      crossorigin="anonymous"
    />

    <!-- Prism.js Syntax Highlighting -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"
      integrity="sha384-06z5D//U/xpvxZHuUz92xBvq3DqBBFi7Up53HRrbV7Jlv7Yvh/MZ7oenfUe9iCEt"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"
      integrity="sha384-HkMr0bZB9kBW4iVtXn6nd35kO/L/dQtkkUBkL9swzTEDMdIe5ExJChVDSnC79aNA"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"
      integrity="sha384-+grZ1BKjM0uVvu5qwWIjfNJct1eZpnnIv7QAo1Qva9uEWA584H7dSk7sZSgwbvT7"
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <header>
      <!-- Navigation -->
      <nav class="navbar" aria-label="Primary">
        <div class="navbar-inner">
          <div class="logo">
            <a href="/index.html">CYB3R4Y4</a>
          </div>

          <ul class="nav-links">
            <li><a href="/index.html">Home</a></li>
            <li><a href="/blog.html">Blog</a></li>
            <li><a href="/tags.html">Tags</a></li>
            <li><a href="/categories.html">Categories</a></li>
            <li><a href="mailto:aj.raya@proton.me">Contact</a></li>
          </ul>
          <button
            id="theme-toggle"
            class="theme-toggle"
            aria-label="Toggle theme"
          >
            <i id="theme-icon" class="fa-solid fa-sun" aria-hidden="true"></i>
            <span class="sr-only">Toggle theme</span>
          </button>
        </div>
      </nav>
    </header>

    <main>
      <section class="section" aria-labelledby="post-title">
        <article class="post-container">
          <h1 id="post-title">
            For Greatness üèÖ - Deobfuscating a PHP Backdoor
          </h1>

          <!-- Semantic meta: use <address> for author and <time> for date -->
          <div class="post-meta" aria-label="Post metadata">
            <span class="author">
              <i class="fa-solid fa-user" aria-hidden="true"></i>
              <address style="display: inline">AJ Raya</address>
            </span>
            <span class="date">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2025-10-10">October 10, 2025</time>
            </span>
          </div>

          <div class="blog-meta-row" aria-label="Category">
            <span class="blog-meta-label">Category:</span>
            <a
              href="/categories.html#malware-analysis"
              class="tag-pill category-pill"
            >
              Malware Analysis
            </a>
          </div>

          <p class="muted tags-line" aria-label="Tags">
            Tags:
            <a href="/tags.html#huntress-ctf-2025" class="tag-pill"
              >huntress-ctf-2025</a
            >
            <a href="/tags.html#obfuscation" class="tag-pill">obfuscation</a>
            <a href="/tags.html#cyberchef" class="tag-pill">cyberchef</a>
            <a href="/tags.html#php" class="tag-pill">php</a>
          </p>

          <!-- Optional: wrap standalone images in <figure> for semantics -->
          <figure>
            <img
              src="/Images/for-greatness/malgal.png"
              alt="For Greatness malware analysis image"
            />
          </figure>

          <figure>
            <img
              src="/Images/for-greatness/chall-prompt.png"
              alt="Challenge prompt screenshot"
            />
          </figure>

          <p>
            In this challenge, we are thrown into a bit of malware analysis. The
            goal: <strong>find the email address that ‚Äúthey‚Äù send to</strong>.
            As usual with CTF web shells and droppers, things are not in plain
            text - the PHP script is heavily obfuscated and layered in multiple
            stages of encoding and compression.
          </p>

          <!-- Replace <br><hr><br> with semantic section divider -->
          <hr />

          <h2>1. Unpacking the challenge archive</h2>

          <p>
            The challenge provides a password-protected archive:
            <code class="inside-code">for_greatness.zip</code> with the password
            <code class="inside-code">infected</code>. I used 7-Zip from the
            terminal to extract it.
          </p>

          <pre><code class="language-bash">7z e for_greatness.zip -p infected

7-Zip 23.01 (x64) : Copyright (c) 1999-2023 Igor Pavlov : 2023-06-20
 64-bit locale=en_US.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive for archives:
1 file, 129762 bytes (127 KiB)

Extracting archive: for_greatness.zip
--
Path = for_greatness.zip
Type = zip
Physical Size = 129762

No files to process
Everything is Ok

Files: 0
Size:       0
Compressed: 129762
</code></pre>

          <p>
            After the extraction I ran a quick listing to see what we actually
            got:
          </p>

          <pre><code class="language-bash">ls -la</code></pre>

          <p>
            Only one file showed up:
            <code class="inside-code">j.php</code>. So the entire puzzle is
            inside a single obfuscated PHP script.
          </p>

          <hr />

          <h2>2. First look at <code class="inside-code">j.php</code></h2>

          <p>
            Next, I opened <code class="inside-code">j.php</code> in VS Code and
            ran a PHP beautifier to make the structure somewhat readable. You
            could also use any online PHP formatter if you do not have a local
            plugin handy.
          </p>

          <figure>
            <img
              src="/Images/for-greatness/php-code.png"
              alt="Obfuscated PHP code displayed in the editor"
            />
            <figcaption>
              The original <code class="inside-code">j.php</code>
            </figcaption>
          </figure>
          <p>A few things stood out immediately:</p>

          <ul>
            <li>Heavy use of <code class="inside-code">goto</code> labels.</li>
            <li>
              A ton of strings built from escaped bytes like
              <code class="inside-code">\x20\40\142...</code>.
            </li>
            <li>
              Dynamic function names and variables that are almost certainly
              used to build dangerous behavior at runtime (for example,
              <code class="inside-code">eval()</code> via
              <code class="inside-code">__lambda</code>).
            </li>
          </ul>

          <p>
            That told me the first step would be to decode all of those string
            literals - the backslash-escaped bytes are hiding something useful.
          </p>

          <hr />

          <h2>3. Unescaping the string literals</h2>

          <p>
            Line by line, I copied the escaped strings into
            <span class="inside-code">CyberChef</span> and used the
            <code class="inside-code">Unescape string</code> recipe to convert
            them into more recognizable text.
          </p>

          <p>
            For example, the string
            <code class="inside-code"
              >\x20\40\142\x32\112\x66\x63\x33\x52\x68\x63\156\121\x3d</code
            >
            became:
          </p>

          <pre><code class="language-bash">b2Jfc3RhcnQ=</code></pre>

          <p>
            That clearly looks like Base64, so the next logical step was to
            decode it from Base64 as well.
          </p>

          <figure>
            <img
              src="/Images/for-greatness/chef1.png"
              alt="CyberChef screenshot showing unescape string and Base64 decoding"
            />
            <figcaption>
              Using CyberChef to
              <code class="inside-code">Unescape string</code>
              and then decode from Base64.
            </figcaption>
          </figure>

          <p>
            After walking through the main string variables this way, I ended up
            with a chunk of reconstructed code and one very long Base64 string
            that clearly needed yet another round of deobfuscation.
          </p>

          <figure>
            <img
              src="/Images/for-greatness/deob-lvl1.png"
              alt="Partially deobfuscated PHP showing a large Base64 blob"
            />
            <figcaption>
              Stage 1 deobfuscation - most control structures readable, but a
              big Base64 blob remains.
            </figcaption>
          </figure>

          <hr />

          <h2>4. Deobfuscation pipeline - Base64 + zlib</h2>

          <p>
            For the large Base64 string, I built a CyberChef pipeline to peel
            off more layers:
          </p>

          <ol>
            <li><code class="inside-code">Unescape string</code></li>
            <li><code class="inside-code">From Base64</code></li>
            <li><code class="inside-code">Zlib Inflate</code></li>
          </ol>

          <p>
            If you are wondering why I reached for
            <code class="inside-code">Zlib Inflate</code> - I checked the raw
            hex first. The blob started with
            <code class="inside-code">78 9C</code>, which is a classic
            <strong>magic number</strong> for zlib-compressed data.
          </p>

          <!-- Removed stray "a" (invalid/unintended content) -->

          <figure>
            <img
              src="/Images/for-greatness/chef2.png"
              alt="Hex view showing 78 9C zlib magic bytes"
            />
            <figcaption>
              The Base64-decoded bytes start with
              <code class="inside-code">0x78 0x9C</code> -
              <strong>zlib compression</strong>.
            </figcaption>
          </figure>

          <figure>
            <img src="/Images/for-greatness/magic.png" alt="Magic bytes" />
            <figcaption>Magic bytes</figcaption>
          </figure>

          <p>
            After this stage, I got yet another chunk of code - still crowded
            with whitespace and not super friendly to read at a glance.
          </p>

          <p>Time to clean it up.</p>

          <hr />

          <h2>5. Cleaning the second-stage payload</h2>

          <p>
            With the zlib output in hand, I stayed in CyberChef and added two
            more steps to the recipe:
          </p>

          <ul>
            <li><code class="inside-code">Remove whitespace</code></li>
            <li><code class="inside-code">Generic Code Beautify</code></li>
          </ul>

          <figure>
            <img
              src="/Images/for-greatness/output1.png"
              alt="CyberChef recipe showing whitespace removed and code beautified"
            />
            <figcaption>
              Removing noisy whitespace and applying Generic Code Beautify to
              make the payload readable.
            </figcaption>
          </figure>

          <figure>
            <img
              src="/Images/for-greatness/php-output.png"
              alt="Second-stage PHP code after beautification"
            />
            <figcaption>
              Second-stage PHP logic revealed - still some obfuscation, but much
              closer to normal application code.
            </figcaption>
          </figure>

          <p>
            Once again, I was left with another Base64-encoded section. At this
            point the pattern was clear - decode until you see something human
            readable and meaningful.
          </p>

          <p>
            I opened a new CyberChef tab, pasted in the Base64 blob, and ran the
            simple recipe:
          </p>

          <pre><code class="language-bash">From Base64</code></pre>

          <figure>
            <img
              src="/Images/for-greatness/chef3.png"
              alt="CyberChef output showing final plain-text payload"
            />
            <figcaption>
              Final decoded payload - now we have human readable PHP and
              strings.
            </figcaption>
          </figure>

          <hr />

          <h2>6. Hunting for the email address</h2>

          <p>
            After decoding the final layer, I copied all of the output into a
            text editor so I could review the logic line by line. Since the goal
            of the challenge was to find the email address where data was being
            sent, I focused on:
          </p>

          <ul>
            <li>
              Any calls to email-related functions (for example,
              <code class="inside-code">mail()</code> in PHP).
            </li>
            <li>Strings that looked like domains or email addresses.</li>
            <li>
              Suspicious constants or variables that might hold exfil endpoints.
            </li>
          </ul>

          <figure>
            <img
              src="/Images/for-greatness/rev-flag.png"
              alt="Decoded PHP payload showing an email address with a reversed flag"
            />
            <figcaption>
              One line jumps out - an email address where the local-part is in
              <strong>flag format, but reversed</strong>.
            </figcaption>
          </figure>

          <p>
            In the decoded payload, I found an email address where the sender
            part was suspiciously shaped like a flag, but reversed. Something
            like:
          </p>

          <pre><code class="language-bash">f}7f113307018770d52d4f94fe013197f{galf@example[.]com</code></pre>

          <p>
            That pattern is too specific to be random. I recognized it as the
            challenge flag written backwards.
          </p>

          <hr />

          <h2>7. Reversing the flag</h2>

          <p>
            To confirm, I copied just the suspicious part into CyberChef and
            used the <code class="inside-code">Reverse</code> operation on the
            string:
          </p>

          <figure>
            <img
              src="/Images/for-greatness/rev-chef.png"
              alt="CyberChef reverse operation applied to the suspected flag"
            />
            <figcaption>
              Applying the Reverse operation to the backwards flag string.
            </figcaption>
          </figure>

          <p>After reversing, the flag appeared in the expected CTF format:</p>

          <pre><code class="language-bash">flag{f791310cef49f4d25d0778107033117f}</code></pre>

          <p>
            I submitted
            <code class="inside-code"
              >flag{f791310cef49f4d25d0778107033117f}</code
            >
            and it was accepted - challenge complete for Day 10!
          </p>

          <figure>
            <img
              src="/Images/for-greatness/chall-complete.png"
              alt="Challenge completion screen for the For Greatness challenge"
            />
            <figcaption>
              Challenge solved - one PHP backdoor, several layers of
              obfuscation, and one reversed flag.
            </figcaption>
          </figure>

          <hr />

          <h2>Malware analysis takeaways from this challenge</h2>

          <ol>
            <li>
              <strong>Obfuscation tends to be layered, not singular.</strong
              ><br />
              This sample chained together escaped strings, Base64 encoding, and
              zlib compression. Get comfortable building deobfuscation
              <em>pipelines</em> instead of expecting a single transformation to
              reveal everything.
            </li>

            <li>
              <strong
                >Encoding and compression signatures are your friends.</strong
              ><br />
              Magic bytes like <code class="inside-code">78 9C</code> (zlib) or
              <code class="inside-code">1F 8B</code> (gzip) are strong hints
              about the next step. Quickly checking hex can save you a lot of
              guessing.
            </li>

            <li>
              <strong
                >Tools like CyberChef are perfect for quick IR triage.</strong
              ><br />
              Being able to interactively build recipes such as
              <code class="inside-code"
                >Unescape string ‚Üí From Base64 ‚Üí Zlib Inflate</code
              >
              speeds up analysis when you are under time pressure.
            </li>

            <li>
              <strong>Look for exfil paths and infrastructure.</strong><br />
              Even in obfuscated PHP, you can usually spot where data is going:
              email addresses, URLs, API endpoints, or hard-coded C2 domains.
              That is often where the flag - or the most actionable intel -
              hides.
            </li>

            <li>
              <strong
                >Read the narrative of the code, not just the syntax.</strong
              ><br />
              Once deobfuscated, walk through the logic: What is being
              collected? Where is it being sent? How is it triggered? Those
              questions map nicely to real-world detections and threat-hunting
              logic later.
            </li>
          </ol>

          <hr />

          <h2>Related MITRE ATT&amp;CK techniques</h2>

          <p>
            This challenge lines up nicely with a few ATT&amp;CK techniques you
            would expect to see in real-world malware:
          </p>

          <ul>
            <li>
              <a
                class="mitre-link"
                href="https://attack.mitre.org/techniques/T1027/"
                target="_blank"
                rel="noopener noreferrer"
                referrerpolicy="no-referrer"
                >T1027 - Obfuscated/Encrypted File or Information</a
              >
              - the PHP script is heavily obfuscated using escaped strings,
              Base64, and compression to hide its real functionality.
            </li>
            <li>
              <a
                class="mitre-link"
                href="https://attack.mitre.org/techniques/T1140/"
                target="_blank"
                rel="noopener noreferrer"
                referrerpolicy="no-referrer"
                >T1140 - Deobfuscate/Decode Files or Information</a
              >
              - at runtime, the script decodes and inflates payloads before
              executing them (mirroring the manual deobfuscation we did in
              analysis).
            </li>
          </ul>
        </article>
      </section>
    </main>

    <!-- Fullscreen image modal (shared with other posts) -->
    <!-- Accessibility: role=dialog, aria-modal, focus management (minimal) -->
    <div
      class="image-modal"
      id="image-modal"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
      aria-label="Image preview"
      tabindex="-1"
    >
      <button class="image-modal-close" type="button" aria-label="Close image">
        &times;
      </button>
      <img src="" alt="" />
    </div>

    <footer class="footer">
      &copy; 2025 AJ Raya. All rights reserved.
      <a href="/privacy.html">Privacy Policy</a>
    </footer>

    <script>
      const themeIcon = document.getElementById("theme-icon");
      const themeToggle = document.getElementById("theme-toggle");
      const storedTheme = localStorage.getItem("theme");

      function setToggleState(isDark) {
        if (themeToggle)
          themeToggle.setAttribute("aria-pressed", String(isDark));
      }

      function enableDark() {
        document.body.classList.add("dark-mode");
        themeIcon.classList.replace("fa-sun", "fa-moon");
        setToggleState(true);
      }

      function enableLight() {
        document.body.classList.remove("dark-mode");
        themeIcon.classList.replace("fa-moon", "fa-sun");
        setToggleState(false);
      }

      if (
        storedTheme === "dark" ||
        (!storedTheme &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        enableDark();
      } else {
        enableLight();
      }

      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          if (document.body.classList.contains("dark-mode")) {
            enableLight();
            localStorage.setItem("theme", "light");
          } else {
            enableDark();
            localStorage.setItem("theme", "dark");
          }
        });
      }
    </script>

    <!-- Image zoom modal logic -->
    <script>
      (function () {
        const modal = document.getElementById("image-modal");
        if (!modal) return;

        const modalImg = modal.querySelector("img");
        const closeBtn = modal.querySelector(".image-modal-close");

        function openModal(src, alt) {
          modalImg.src = src;
          modalImg.alt = alt || "";
          modal.classList.add("open");
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";

          // Accessibility: move focus into dialog
          modal.focus();
        }

        function closeModal() {
          modal.classList.remove("open");
          modal.setAttribute("aria-hidden", "true");
          modalImg.src = "";
          document.body.style.overflow = "";
        }

        document.querySelectorAll(".post-container img").forEach((img) => {
          img.addEventListener("click", () => {
            openModal(img.src, img.alt);
          });

          // Accessibility: allow keyboard users to open images
          img.setAttribute("tabindex", "0");
          img.setAttribute("role", "button");
          img.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              openModal(img.src, img.alt);
            }
          });
        });

        modal.addEventListener("click", (e) => {
          if (e.target === modal || e.target === closeBtn) {
            closeModal();
          }
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.classList.contains("open")) {
            closeModal();
          }
        });
      })();
    </script>

    <!-- Code block copy buttons -->
    <script>
      (function () {
        const codeBlocks = document.querySelectorAll(
          ".post-container pre > code"
        );
        if (!codeBlocks.length) return;

        codeBlocks.forEach((code) => {
          const pre = code.parentElement;
          if (!pre) return;

          pre.classList.add("code-block");

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "code-copy-btn";
          btn.setAttribute("aria-label", "Copy code to clipboard");
          btn.innerHTML = `
            <i class="fa-regular fa-clipboard" aria-hidden="true"></i>
            <span>Copy</span>
          `;

          btn.addEventListener("click", async () => {
            const text = code.innerText || code.textContent || "";

            const copy = async () => {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
              }

              const textarea = document.createElement("textarea");
              textarea.value = text;
              textarea.style.position = "fixed";
              textarea.style.left = "-9999px";
              document.body.appendChild(textarea);
              textarea.select();
              try {
                document.execCommand("copy");
              } finally {
                document.body.removeChild(textarea);
              }
            };

            try {
              await copy();
              btn.classList.add("copied");
              btn.innerHTML = `
                <i class="fa-solid fa-check" aria-hidden="true"></i>
                <span>Copied</span>
              `;
              setTimeout(() => {
                btn.classList.remove("copied");
                btn.innerHTML = `
                  <i class="fa-regular fa-clipboard" aria-hidden="true"></i>
                  <span>Copy</span>
                `;
              }, 1500);
            } catch (err) {
              console.error("Copy failed:", err);
              btn.classList.add("copied");
              btn.innerHTML = `
                <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
                <span>Error</span>
              `;
              setTimeout(() => {
                btn.classList.remove("copied");
                btn.innerHTML = `
                  <i class="fa-regular fa-clipboard" aria-hidden="true"></i>
                  <span>Copy</span>
                `;
              }, 2000);
            }
          });

          pre.appendChild(btn);
        });
      })();
    </script>
  </body>
</html>
